<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beauty Agent</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">Beauty Agent</div>
          <div class="subtitle">Retail + 리뷰 + SNS 신호 → Launch Brief / Radar / Pulse / Alerts</div>
        </div>
      </div>

      <div class="controls">
        <input id="userId" class="input" value="test" />
        <button id="btnHistory" class="btn ghost">History</button>
        <button id="btnRadar" class="btn ghost">Radar</button>
        <button id="btnPulse" class="btn ghost">Pulse</button>
        <button id="btnAlerts" class="btn ghost">Alerts</button>
        <button id="btnReset" class="btn">Reset</button>
      </div>
    </header>

    <main class="panel">
      <div id="chat" class="chat"></div>

      <div class="composer">
        <input id="msg" class="input grow" placeholder="예) 미국에서 선케어 신제품 기획하려고 해" />
        <button id="send" class="btn">Send</button>
      </div>
    </main>

    <footer class="foot">
      <a href="/docs" target="_blank">API Docs</a>
      <span>·</span>
      <a href="/health" target="_blank">Health</a>
      <span>·</span>
      <a href="/api" target="_blank">API Root</a>
    </footer>
  </div>

  <script src="/static/app.js"></script>


<!-- ===== BEGIN_REPORT_BUTTON_V3 ===== -->
<style>
  #finalReportBtnV3{
    position:fixed; right:18px; bottom:18px; z-index:2147483647;
    padding:12px 14px; border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(20,20,24,.92);
    color:rgba(255,255,255,.92);
    font-weight:900; cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
  }
  #finalReportBtnV3:hover{ transform: translateY(-1px); }
  #finalReportBtnV3:active{ transform: translateY(0); }
</style>

<script>
(function(){
  function log(){ try{ console.log("[report-btn]", ...arguments); }catch(e){} }

  function safeGetLS(k){
    try{ return (localStorage.getItem(k) || "").trim(); }catch(e){ return ""; }
  }
  function safeSetLS(k,v){
    try{ localStorage.setItem(k, (v||"").toString()); }catch(e){}
  }

  function pickTextFrom(el){
    if (!el) return "";
    if (typeof el.value === "string" && el.value.trim()) return el.value.trim();
    if (el.isContentEditable && el.textContent && el.textContent.trim()) return el.textContent.trim();
    if (el.textContent && el.textContent.trim()) return el.textContent.trim();
    return "";
  }

  function guessUserId(){
    const candidates = [
      document.querySelector("#user_id"),
      document.querySelector("input[name='user_id']"),
      document.querySelector("#uid"),
      document.querySelector("#userid")
    ].filter(Boolean);
    for (const el of candidates){
      const v = pickTextFrom(el);
      if (v) return v;
    }
    const v2 = safeGetLS("user_id");
    return v2 || "test";
  }

  function guessQuery(){
    const selectors = [
      "#query","#message","#msg","#input","#text",
      "textarea","input[type='text']","input[type='search']",
      "[contenteditable='true']",
      ".ProseMirror", ".ql-editor"
    ];
    for (const sel of selectors){
      const el = document.querySelector(sel);
      const v = pickTextFrom(el);
      if (v && v.length >= 3) return v;
    }

    const last = safeGetLS("last_query");
    if (last && last.length >= 3) return last;

    const p = prompt("리포트 생성할 검색 키워드 입력\n예: korean sunscreen white cast sensitive skin", last || "");
    return (p || "").trim();
  }

  function openReport(){
    const userId = guessUserId();
    const q = guessQuery();
    if (!q) { alert("query가 비어있어서 리포트를 열 수 없음."); return; }
    safeSetLS("last_query", q);

    const base = window.location.origin;
    const url = base + "/report/cards?user_id=" + encodeURIComponent(userId)
              + "&query=" + encodeURIComponent(q)
              + "&limit=25";
    log("open", url);
    window.open(url, "_blank", "noopener");
  }

  function attach(){
    if (document.getElementById("finalReportBtnV3")) return;

    const btn = document.createElement("button");
    btn.id = "finalReportBtnV3";
    btn.type = "button";
    btn.title = "마지막 query로 카드뉴스 리포트 열기";
    btn.textContent = "📌 최종 리포트 요약";
    btn.addEventListener("click", openReport);
    document.body.appendChild(btn);

    document.addEventListener("input", function(ev){
      const t = ev.target;
      if (!t) return;
      const id = (t.id || "").toLowerCase();
      const cls = (t.className || "").toString().toLowerCase();
      const tag = (t.tagName || "").toLowerCase();

      const looksLikeInput =
        tag === "textarea" ||
        tag === "input" ||
        t.isContentEditable ||
        id.includes("query") || id.includes("message") || id.includes("input") ||
        cls.includes("query") || cls.includes("message") || cls.includes("input") ||
        cls.includes("prosemirror") || cls.includes("ql-editor");

      if (!looksLikeInput) return;

      const v = pickTextFrom(t);
      if (v && v.length >= 3) safeSetLS("last_query", v);
    }, true);

    log("attached");
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", attach);
  } else {
    attach();
  }
})();
</script>
<!-- ===== END_REPORT_BUTTON_V3 ===== -->

</body>
</html>


